#!/usr/bin/env bash

set -euo pipefail

help() {
	cat << EOF

Usage: gh combine-prs --query "QUERY"
	Combines multiple PRs into one.

	Required arguments:
		--query "QUERY"
				sets the query used to find combinable PRs.
				e.g. --query "author:app/dependabot"
				to combine Dependabot PRs
	Optional arguments:
		--branch-name <branch-name>
				name of branch used to combined PRs
				e.g. --branch-name "combined-prs/$(date +%s)"
				Defaults to "combined-pr-branch"
		--label <COMMA,SEPARATED,LIST>
				list of labels to apply to PR
				e.g. --label glorious,catpants
				Defaults to "dependencies"
		--limit LIMIT
				sets the maximum number of PRs that will be combined.
				Defaults to 50
		--no-label
				don't apply any label to the PR
				Defaults to false when not specified
		--selected-pr-numbers <COMMA,SEPARATED,LIST>
				if set, will only work on PRs with the selected numbers.
				e.g. --selected-pr-numbers 42,13,78
				Defaults to selecting every PR matching the QUERY
		--skip-pr-check
				if set, will combine matching PRs even if they are not passing checks.
				Defaults to false when not specified
		--title <PR-title>
				Title of created PR
				e.g. --title "Look at all these PRs I combined"
				Defaults to "Combined dependencies PR"

EOF
}

confirm() {
	while read -r -n1 key; do
		if [[ $key == $'\e' ]]; then
			exit 0
		else
			break
		fi
	done
}

COMBINED_BRANCH=combined-pr-branch
DRY_RUN=
LIMIT=50
PR_LABEL=dependencies
PR_TITLE="Combined dependencies PR"
QUERY=""
SKIP_PR_CHECK="false"
SELECTED_PR_NUMBERS=
while [ $# -gt 0 ]; do
	case "$1" in
	-h|--help)
		help
		exit 0
		;;
	--branch-name)
		shift
		COMBINED_BRANCH="$1"
		;;
	--label)
		shift
		PR_LABEL="$1"
		;;
	--limit)
		shift
		LIMIT=$1
		;;
	--no-label)
		unset PR_LABEL
		;;
	--query)
		shift
		QUERY=$1
		;;
	--selected-pr-numbers)
		shift
		SELECTED_PR_NUMBERS=$1
		;;
	--skip-pr-check)
		SKIP_PR_CHECK="true"
		;;
	--title)
		shift
		PR_TITLE="$1"
		;;
	*)
		help >&2
		exit 1
		;;
	esac
	shift
done

DEFAULT_BRANCH=$(gh api /repos/:owner/:repo --jq '.default_branch')
BODY_FILE=/tmp/.combined-pr-body.md

if [[ -z "${QUERY}" ]]; then
	help
	echo "Error: --query is required; e.g. --query \"author:app/dependabot\""
	exit 1
fi

cat <<- EOF > $BODY_FILE
	Combining multiple dependencies PRs into one.

	<details>
	<summary>Instructions for merging</summary>

	* **Use a merge commit**, so that GitHub will mark all original PRs as merged.
	* If your repository does not have merge commits enabled, please temporarily enable them in settings. Tick \`Allow merge commits\` in the repository settings.
	* When ready, merge this PR using \`Create a merge commit\`.

	</details>

	## Combined PRs

EOF

echo "The following PRs will be evaluated for inclusion:"
gh pr list --search "${QUERY}" --limit "${LIMIT}"
if [[ "${SKIP_PR_CHECK}" == "true" ]]; then
	echo -e "\nAction status checks for PRs will be skipped"
fi
JQ_FILTER=".[]"
if [[ -n "${SELECTED_PR_NUMBERS}" ]]; then
	echo -e "\nOnly the following PRs will be selected: $SELECTED_PR_NUMBERS"
	JQ_FILTER="$JQ_FILTER | select(.number == ($SELECTED_PR_NUMBERS))"
fi
echo "Press any key to continue or escape to abort"
confirm

git fetch
git checkout "${DEFAULT_BRANCH}"
git pull --ff-only

git branch -D "$COMBINED_BRANCH" || true
git checkout -b "$COMBINED_BRANCH"

count=0
gh pr list --search "${QUERY}" --limit "${LIMIT}" --json headRefName,number | jq -r "$JQ_FILTER | [.number,.headRefName] | @tsv" | while read -r NUMBER HEADREF
do
	if [[ "${SKIP_PR_CHECK}" == "false" ]] && [[ $(gh pr checks "$NUMBER" | cut -d$'\t' -f2 | grep -E "fail|pending" -c) -gt 0 ]]; then
		echo "Not all checks are passing - skipping PR #$NUMBER"
		continue
	fi

	echo "Trying to merge $HEADREF into $COMBINED_BRANCH"
	if [[ ! $(git merge "origin/$HEADREF" --no-edit) ]]; then
		echo "Unable to merge $HEADREF - skipping PR #$NUMBER"
		git merge --abort
		continue
	fi
	echo "Merged $HEADREF (#$NUMBER) into $COMBINED_BRANCH"

	DESCRIPTION=$(gh pr view "$NUMBER" --json title,author,number --template '{{.title}} (#{{.number}}) @{{.author.login}}')
	echo "* ${DESCRIPTION}" >> $BODY_FILE

	((count=count+1))
	if [[ $count == "$LIMIT" ]]; then
		echo "Hit limit of $LIMIT - no more PRs will be added"
		break
	fi
done

echo -e "Preview of PR:\n\n"
cat $BODY_FILE

echo -e "\n\nFinished merging - press any key to create PR or escape to abort"
confirm

echo "Creating PR"
gh pr create --title "$PR_TITLE" --body-file $BODY_FILE ${PR_LABEL:+--label "$PR_LABEL"}
